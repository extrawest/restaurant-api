image: node:18

stages:
  - build
  - deploy

build:
  stage: build
  before_script:
    - yarn install
  script:
    - yarn lint:all
    - yarn build
  artifacts:
    expire_in: 1 hour
    paths:
      - dist
  only:
    - main
    - feature/ci-cd-setup

deploy:
  stage: deploy
  needs:
    - build
  variables:
    JWT_SECRET: $SSH_PASSWORD
    FORGOT_PASS_SECRET: $FORGOT_PASS_SECRET
    MAILTRAP_USER: $MAILTRAP_USER
    MAILTRAP_PASSWORD: $MAILTRAP_PASSWORD
    DB_HOST: $DB_HOST
    DB_PORT: $DB_PORT
    DB_USERNAME: $DB_USERNAME
    DB_PASSWORD: $DB_PASSWORD
    DB_NAME: $DB_NAME
    RABBITMQ_DEFAULT_USER: $RABBITMQ_DEFAULT_USER
    RABBITMQ_DEFAULT_PASS: $RABBITMQ_DEFAULT_PASS
    RABBITMQ_HOST: $RABBITMQ_HOST
    RABBITMQ_QUEUE_NAME: $RABBITMQ_QUEUE_NAME
  before_script:
    - apt-get update -qq && apt-get install -y -qq sshpass rsync
    - bash ./deployment/generate-env.sh
  script:
    - sshpass -V
    - export SSHPASS=$SSH_PASSWORD
    - sshpass -e rsync --progress --links --recursive --delete --checksum -e "ssh -o StrictHostKeyChecking=no" $CI_PROJECT_DIR/dist/apps/restaurant-server/ $SSH_USER@$SERVER_IPADDRESS:$PROJECT_PATH
    - sshpass -e rsync --progress --links --recursive --delete --checksum -e "ssh -o StrictHostKeyChecking=no" $CI_PROJECT_DIR/Dockerfile $CI_PROJECT_DIR/compose.yaml $SSH_USER@$SERVER_IPADDRESS:$PROJECT_PATH
    - sshpass -e rsync --progress --links --recursive --delete --checksum -e "ssh -o StrictHostKeyChecking=no" $CI_PROJECT_DIR/.env $SSH_USER@$SERVER_IPADDRESS:$PROJECT_PATH
    - sshpass -e ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IPADDRESS "cd $PROJECT_PATH && docker compose up -d"
  only:
    - main
    - feature/ci-cd-setup